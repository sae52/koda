--// SERVICES
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local LP = Players.LocalPlayer
local Mouse = LP:GetMouse()

--// STATES
local UIVisible = true

local AimEnabled = true
local LockEnabled = false
local StickyEnabled = false
local LockedTarget = nil

local Prediction = 0.15
local CamSmooth = 0.25

local LockKey = Enum.KeyCode.T

--// UI
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "CleanAimUI"

local main = Instance.new("Frame", gui)
main.Size = UDim2.fromScale(0.35, 0.42)
main.Position = UDim2.fromScale(0.33, 0.3)
main.BackgroundColor3 = Color3.fromRGB(15,15,15)
main.Active = true
main.Draggable = true
Instance.new("UICorner", main)

local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1,0,0.12,0)
title.Text = "Aim / Prediction"
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 18

local frame = Instance.new("Frame", main)
frame.Position = UDim2.fromScale(0,0.12)
frame.Size = UDim2.new(1,0,0.88,0)
frame.BackgroundTransparency = 1

--// UI HELPERS
local function button(text,y,callback)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.fromScale(0.9,0.12)
	b.Position = UDim2.fromScale(0.05,y)
	b.Text = text
	b.BackgroundColor3 = Color3.fromRGB(30,30,30)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.Gotham
	b.TextSize = 14
	b.MouseButton1Click:Connect(callback)
	return b
end

local function slider(text,y,min,max,value,callback)
	local f = Instance.new("Frame", frame)
	f.Size = UDim2.fromScale(0.9,0.16)
	f.Position = UDim2.fromScale(0.05,y)
	f.BackgroundTransparency = 1

	local label = Instance.new("TextLabel", f)
	label.Size = UDim2.fromScale(1,0.4)
	label.Text = text.." : "..value
	label.TextColor3 = Color3.new(1,1,1)
	label.BackgroundTransparency = 1
	label.Font = Enum.Font.Gotham
	label.TextSize = 13

	local bar = Instance.new("Frame", f)
	bar.Position = UDim2.fromScale(0,0.6)
	bar.Size = UDim2.fromScale(1,0.25)
	bar.BackgroundColor3 = Color3.fromRGB(40,40,40)

	local fill = Instance.new("Frame", bar)
	fill.Size = UDim2.fromScale((value-min)/(max-min),1)
	fill.BackgroundColor3 = Color3.fromRGB(120,120,255)

	local dragging = false

	bar.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
		end
	end)

	UIS.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)

	RunService.RenderStepped:Connect(function()
		if dragging then
			local x = math.clamp((Mouse.X - bar.AbsolutePosition.X)/bar.AbsoluteSize.X,0,1)
			fill.Size = UDim2.fromScale(x,1)
			local val = math.floor((min+(max-min)*x)*100)/100
			label.Text = text.." : "..val
			callback(val)
		end
	end)
end

--// UI CONTROLS
button("Sticky Lock",0,function()
	StickyEnabled = not StickyEnabled
	if not StickyEnabled then
		LockedTarget = nil
	end
end)

slider("Prediction Amount",0.25,0,1,Prediction,function(v)
	Prediction = v
end)

slider("Camera Smooth",0.48,0,1,CamSmooth,function(v)
	CamSmooth = v
end)

--// INPUT
UIS.InputBegan:Connect(function(input,gp)
	if gp then return end

	if input.KeyCode == Enum.KeyCode.RightAlt then
		UIVisible = not UIVisible
		gui.Enabled = UIVisible
	end

	if input.KeyCode == LockKey then
		LockEnabled = not LockEnabled
		if not LockEnabled then
			LockedTarget = nil
		end
	end
end)

--// TARGET FIND
local function getClosest()
	local closest,dist
	for _,p in pairs(Players:GetPlayers()) do
		if p ~= LP and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local pos,vis = Camera:WorldToViewportPoint(p.Character.HumanoidRootPart.Position)
			if vis then
				local d = (Vector2.new(pos.X,pos.Y)-Vector2.new(Mouse.X,Mouse.Y)).Magnitude
				if not dist or d < dist then
					dist = d
					closest = p
				end
			end
		end
	end
	return closest
end

--// AIM LOOP (STICKY IS CORRECT)
RunService.RenderStepped:Connect(function()
	if not AimEnabled or not LockEnabled then return end

	if not LockedTarget then
		LockedTarget = getClosest()
	end

	if LockedTarget and LockedTarget.Character and LockedTarget.Character:FindFirstChild("HumanoidRootPart") then
		local hrp = LockedTarget.Character.HumanoidRootPart

		local targetPos = hrp.Position + (hrp.Velocity * Prediction)

		Camera.CFrame = Camera.CFrame:Lerp(
			CFrame.new(Camera.CFrame.Position, targetPos),
			CamSmooth
		)
	end
end)
