--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local LP = Players.LocalPlayer

--// STATE
local aimEnabled = false
local stickyEnabled = false
local espEnabled = false
local nameESPEnabled = true
local skeletonESPEnabled = false

local stickyTarget = nil
local predictionTime = 0.15
local humanRobotValue = 50

--// UI =========================================================
local gui = Instance.new("ScreenGui", LP.PlayerGui)
gui.ResetOnSpawn = false

local main = Instance.new("Frame", gui)
main.Size = UDim2.fromOffset(380, 330)
main.Position = UDim2.fromScale(0.5,0.5)
main.AnchorPoint = Vector2.new(0.5,0.5)
main.BackgroundColor3 = Color3.fromRGB(15,15,15)
main.BorderSizePixel = 0
Instance.new("UICorner", main).CornerRadius = UDim.new(0,12)

-- Drag
do
    local drag, start, pos
    main.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            drag = true
            start = i.Position
            pos = main.Position
        end
    end)
    UIS.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then drag = false end
    end)
    UIS.InputChanged:Connect(function(i)
        if drag and i.UserInputType == Enum.UserInputType.MouseMovement then
            local d = i.Position - start
            main.Position = UDim2.new(pos.X.Scale, pos.X.Offset+d.X, pos.Y.Scale, pos.Y.Offset+d.Y)
        end
    end)
end

-- UI Toggle (RightAlt)
UIS.InputBegan:Connect(function(i,gp)
    if not gp and i.KeyCode == Enum.KeyCode.RightAlt then
        gui.Enabled = not gui.Enabled
    end
end)

-- Sticky toggle key (T)
UIS.InputBegan:Connect(function(i,gp)
    if gp then return end
    if i.KeyCode == Enum.KeyCode.T then
        stickyEnabled = not stickyEnabled
        if not stickyEnabled then stickyTarget = nil end
    end
end)

-- Tabs
local tabBar = Instance.new("Frame", main)
tabBar.Size = UDim2.fromScale(1,0.14)
tabBar.BackgroundTransparency = 1

local function tab(text,x)
    local b = Instance.new("TextButton", tabBar)
    b.Size = UDim2.fromScale(0.5,1)
    b.Position = UDim2.fromScale(x,0)
    b.Text = text
    b.Font = Enum.Font.GothamBold
    b.TextSize = 18
    b.BackgroundColor3 = Color3.fromRGB(25,25,25)
    b.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", b)
    return b
end

local aimTab = tab("AIM",0)
local espTab = tab("ESP",0.5)

local AimFrame = Instance.new("Frame", main)
AimFrame.Position = UDim2.fromScale(0,0.14)
AimFrame.Size = UDim2.fromScale(1,0.86)
AimFrame.BackgroundTransparency = 1

local ESPFrame = AimFrame:Clone()
ESPFrame.Parent = main
ESPFrame.Visible = false

local function button(parent,text,y)
    local b = Instance.new("TextButton", parent)
    b.Size = UDim2.fromScale(0.9,0.12)
    b.Position = UDim2.fromScale(0.05,y)
    b.Text = text
    b.Font = Enum.Font.Gotham
    b.TextScaled = true
    b.BackgroundColor3 = Color3.fromRGB(25,25,25)
    b.TextColor3 = Color3.new(1,1,1)
    Instance.new("UICorner", b)
    return b
end

-- AIM UI
local aimBtn = button(AimFrame,"AIM: OFF",0.05)
local stickyBtn = button(AimFrame,"STICKY (T): OFF",0.20)

-- ESP UI
local espBtn = button(ESPFrame,"ESP: OFF",0.05)
local nameBtn = button(ESPFrame,"NAME ESP: ON",0.20)
local skelBtn = button(ESPFrame,"SKELETON ESP: OFF",0.35)

aimTab.MouseButton1Click:Connect(function()
    AimFrame.Visible = true
    ESPFrame.Visible = false
end)
espTab.MouseButton1Click:Connect(function()
    AimFrame.Visible = false
    ESPFrame.Visible = true
end)

aimBtn.MouseButton1Click:Connect(function()
    aimEnabled = not aimEnabled
    aimBtn.Text = aimEnabled and "AIM: ON" or "AIM: OFF"
end)

stickyBtn.MouseButton1Click:Connect(function()
    stickyEnabled = not stickyEnabled
    stickyBtn.Text = stickyEnabled and "STICKY (T): ON" or "STICKY (T): OFF"
    if not stickyEnabled then stickyTarget = nil end
end)

--// ESP SYSTEM ================================================
local espCache = {}

local function clearESP(p)
    if espCache[p] then
        for _,v in pairs(espCache[p]) do v:Destroy() end
        espCache[p] = nil
    end
end

local function clearAllESP()
    for p,_ in pairs(espCache) do
        clearESP(p)
    end
end

espBtn.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    espBtn.Text = espEnabled and "ESP: ON" or "ESP: OFF"
    clearAllESP()
end)

nameBtn.MouseButton1Click:Connect(function()
    nameESPEnabled = not nameESPEnabled
    nameBtn.Text = nameESPEnabled and "NAME ESP: ON" or "NAME ESP: OFF"
    clearAllESP()
end)

skelBtn.MouseButton1Click:Connect(function()
    skeletonESPEnabled = not skeletonESPEnabled
    skelBtn.Text = skeletonESPEnabled and "SKELETON ESP: ON" or "SKELETON ESP: OFF"
    clearAllESP()
end)

-- Skeleton builder
local function skeleton(char)
    local beams = {}
    local function link(a,b)
        local at0,at1 = Instance.new("Attachment",a),Instance.new("Attachment",b)
        local bm = Instance.new("Beam")
        bm.Attachment0, bm.Attachment1 = at0, at1
        bm.Width0, bm.Width1 = 0.05,0.05
        bm.FaceCamera = true
        bm.Color = ColorSequence.new(Color3.new(1,1,1))
        bm.Parent = a
        table.insert(beams,bm)
    end
    link(char.Head,char.UpperTorso)
    link(char.UpperTorso,char.LeftUpperArm)
    link(char.UpperTorso,char.RightUpperArm)
    link(char.UpperTorso,char.LeftUpperLeg)
    link(char.UpperTorso,char.RightUpperLeg)
    return beams
end

local function makeESP(p)
    if not p.Character then return end
    espCache[p] = {}

    if nameESPEnabled then
        local b = Instance.new("BillboardGui", p.Character.Head)
        b.Size = UDim2.fromOffset(100,18)
        b.StudsOffset = Vector3.new(0,2.5,0)
        b.AlwaysOnTop = true
        local t = Instance.new("TextLabel", b)
        t.Size = UDim2.fromScale(1,1)
        t.BackgroundTransparency = 1
        t.Text = p.Name
        t.Font = Enum.Font.Gotham
        t.TextSize = 12
        t.TextColor3 = Color3.new(1,1,1)
        table.insert(espCache[p], b)
    end

    if skeletonESPEnabled then
        for _,v in pairs(skeleton(p.Character)) do
            table.insert(espCache[p], v)
        end
    end
end

--// TARGETING ==================================================
local function getClosest()
    local best, dist = nil, math.huge
    for _,p in pairs(Players:GetPlayers()) do
        if p ~= LP and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local v,on = Camera:WorldToViewportPoint(p.Character.HumanoidRootPart.Position)
            if on then
                local d = (Vector2.new(v.X,v.Y)-UIS:GetMouseLocation()).Magnitude
                if d < dist then dist = d best = p end
            end
        end
    end
    return best
end

--// CAMERA ASSIST =============================================
RunService.RenderStepped:Connect(function()
    if not aimEnabled then return end

    if not (stickyEnabled and stickyTarget and stickyTarget.Character) then
        stickyTarget = getClosest()
    end

    if not stickyTarget or not stickyTarget.Character then return end
    local hrp = stickyTarget.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local predicted = hrp.Position + hrp.Velocity * predictionTime
    local speed = math.clamp(humanRobotValue/100,0.02,1)

    Camera.CFrame = Camera.CFrame:Lerp(
        CFrame.new(Camera.CFrame.Position, predicted),
        speed
    )
end)

-- ESP update loop
RunService.RenderStepped:Connect(function()
    for _,p in pairs(Players:GetPlayers()) do
        if p ~= LP then
            if espEnabled then
                if not espCache[p] then makeESP(p) end
            else
                clearESP(p)
            end
        end
    end
end)
