--// SERVICES
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

--// STATE
local UIVisible = true
local AimEnabled = false
local StickyEnabled = false
local LockedTarget = nil

local Prediction = 0.1
local Smoothness = 0.5 -- human vs robot
local CamSpeed = 0.5

local ESPEnabled = false
local NameESPEnabled = false
local SkeletonESPEnabled = false

--// UI SETUP
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "CleanAimUI"

local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.fromScale(0.35, 0.4)
Main.Position = UDim2.fromScale(0.33, 0.3)
Main.BackgroundColor3 = Color3.fromRGB(15,15,15)
Main.Active = true
Main.Draggable = true

local UICorner = Instance.new("UICorner", Main)

--// TITLE
local Title = Instance.new("TextLabel", Main)
Title.Size = UDim2.new(1,0,0.12,0)
Title.Text = "Aim / ESP Panel"
Title.TextColor3 = Color3.new(1,1,1)
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18

--// TABS
local Tabs = Instance.new("Frame", Main)
Tabs.Position = UDim2.fromScale(0,0.12)
Tabs.Size = UDim2.new(1,0,0.12,0)
Tabs.BackgroundTransparency = 1

local AimTab = Instance.new("TextButton", Tabs)
AimTab.Size = UDim2.fromScale(0.5,1)
AimTab.Text = "AIM"

local ESPTab = Instance.new("TextButton", Tabs)
ESPTab.Size = UDim2.fromScale(0.5,1)
ESPTab.Position = UDim2.fromScale(0.5,0)
ESPTab.Text = "ESP"

for _,b in pairs({AimTab,ESPTab}) do
	b.BackgroundColor3 = Color3.fromRGB(25,25,25)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.Gotham
	b.TextSize = 14
end

--// CONTENT FRAMES
local AimFrame = Instance.new("Frame", Main)
AimFrame.Position = UDim2.fromScale(0,0.24)
AimFrame.Size = UDim2.new(1,0,0.76,0)
AimFrame.BackgroundTransparency = 1

local ESPFrame = AimFrame:Clone()
ESPFrame.Parent = Main
ESPFrame.Visible = false

--// TAB LOGIC
AimTab.MouseButton1Click:Connect(function()
	AimFrame.Visible = true
	ESPFrame.Visible = false
end)

ESPTab.MouseButton1Click:Connect(function()
	AimFrame.Visible = false
	ESPFrame.Visible = true
end)

--// UI HELPERS
local function Button(parent,text,y,callback)
	local b = Instance.new("TextButton", parent)
	b.Size = UDim2.fromScale(0.9,0.12)
	b.Position = UDim2.fromScale(0.05,y)
	b.Text = text
	b.BackgroundColor3 = Color3.fromRGB(30,30,30)
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.Gotham
	b.TextSize = 14
	b.MouseButton1Click:Connect(callback)
	return b
end

local function Slider(parent,text,y,min,max,default,changed)
	local Frame = Instance.new("Frame", parent)
	Frame.Size = UDim2.fromScale(0.9,0.14)
	Frame.Position = UDim2.fromScale(0.05,y)
	Frame.BackgroundTransparency = 1

	local Label = Instance.new("TextLabel", Frame)
	Label.Size = UDim2.fromScale(1,0.4)
	Label.Text = text.." : "..default
	Label.TextColor3 = Color3.new(1,1,1)
	Label.BackgroundTransparency = 1
	Label.Font = Enum.Font.Gotham
	Label.TextSize = 13

	local Bar = Instance.new("Frame", Frame)
	Bar.Position = UDim2.fromScale(0,0.6)
	Bar.Size = UDim2.fromScale(1,0.3)
	Bar.BackgroundColor3 = Color3.fromRGB(40,40,40)

	local Fill = Instance.new("Frame", Bar)
	Fill.Size = UDim2.fromScale((default-min)/(max-min),1)
	Fill.BackgroundColor3 = Color3.fromRGB(120,120,255)

	local dragging = false

	Bar.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
		end
	end)

	UIS.InputEnded:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = false
		end
	end)

	RunService.RenderStepped:Connect(function()
		if dragging then
			local x = (Mouse.X - Bar.AbsolutePosition.X) / Bar.AbsoluteSize.X
			x = math.clamp(x,0,1)
			Fill.Size = UDim2.fromScale(x,1)
			local val = math.floor((min + (max-min)*x)*100)/100
			Label.Text = text.." : "..val
			changed(val)
		end
	end)
end

--// AIM UI
Button(AimFrame,"Aim Enabled",0,function()
	AimEnabled = not AimEnabled
end)

Button(AimFrame,"Sticky Lock",0.14,function()
	StickyEnabled = not StickyEnabled
	if not StickyEnabled then LockedTarget = nil end
end)

Slider(AimFrame,"Prediction",0.3,0,1,Prediction,function(v) Prediction = v end)
Slider(AimFrame,"Human vs Robot",0.46,0,1,Smoothness,function(v) Smoothness = v end)
Slider(AimFrame,"Camera Speed",0.62,0,1,CamSpeed,function(v) CamSpeed = v end)

--// ESP UI
Button(ESPFrame,"ESP Enabled",0,function()
	ESPEnabled = not ESPEnabled
end)

Button(ESPFrame,"Name ESP",0.14,function()
	NameESPEnabled = not NameESPEnabled
end)

Button(ESPFrame,"Skeleton ESP",0.28,function()
	SkeletonESPEnabled = not SkeletonESPEnabled
end)

--// INPUT KEYS
UIS.InputBegan:Connect(function(i,gp)
	if gp then return end

	if i.KeyCode == Enum.KeyCode.RightAlt then
		UIVisible = not UIVisible
		ScreenGui.Enabled = UIVisible
	end

	if i.KeyCode == Enum.KeyCode.T then
		AimEnabled = not AimEnabled
		if not AimEnabled then LockedTarget = nil end
	end
end)

--// TARGETING
local function GetClosest()
	local closest,dist
	for _,p in pairs(Players:GetPlayers()) do
		if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local pos,_ = Camera:WorldToViewportPoint(p.Character.HumanoidRootPart.Position)
			local d = (Vector2.new(pos.X,pos.Y) - Vector2.new(Mouse.X,Mouse.Y)).Magnitude
			if not dist or d < dist then
				dist = d
				closest = p
			end
		end
	end
	return closest
end

--// AIM LOOP
RunService.RenderStepped:Connect(function()
	if not AimEnabled then return end

	if StickyEnabled and LockedTarget then
		-- keep
	else
		LockedTarget = GetClosest()
	end

	if LockedTarget and LockedTarget.Character and LockedTarget.Character:FindFirstChild("HumanoidRootPart") then
		local hrp = LockedTarget.Character.HumanoidRootPart
		local predicted = hrp.Position + hrp.Velocity * Prediction
		local cf = CFrame.new(Camera.CFrame.Position, predicted)
		Camera.CFrame = Camera.CFrame:Lerp(cf, CamSpeed * (1-Smoothness))
	end
end)
